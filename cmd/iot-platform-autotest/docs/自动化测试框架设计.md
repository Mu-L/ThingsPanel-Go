# IoT Platform 自动化测试框架设计

## 1. 项目概述

### 1.1 目标
构建一个自动化测试框架,用于验证 ThingsPanel IoT 平台的设备接入、数据上报、指令下发等核心功能。

### 1.2 测试范围
- MQTT 直连设备和网关设备模拟
- 设备数据上报(遥测、属性、事件)验证
- 平台指令下发(控制、属性设置、命令)验证
- 数据入库验证
- 消息响应验证
- 多级网关拓扑测试

---

## 2. 项目结构

```
iot-platform-autotest/
│
├── cmd/
│   └── autotest/
│       └── main.go                    # 主程序入口
│
├── internal/
│   ├── config/
│   │   ├── config.go                  # 配置结构定义
│   │   └── loader.go                  # 配置加载器
│   │
│   ├── device/
│   │   ├── device.go                  # 设备接口定义
│   │   ├── direct_device.go           # 直连设备实现
│   │   ├── gateway_device.go          # 网关设备实现
│   │   ├── factory.go                 # 设备工厂
│   │   └── topology.go                # 拓扑结构定义
│   │
│   ├── protocol/
│   │   ├── message_builder.go         # 消息构建器接口
│   │   ├── direct_builder.go          # 直连设备消息构建
│   │   └── gateway_builder.go         # 网关设备消息构建
│   │
│   ├── platform/
│   │   ├── api_client.go              # HTTP API客户端
│   │   └── db_client.go               # 数据库查询客户端
│   │
│   └── utils/
│       ├── mqtt_topics.go             # MQTT主题构建(支持 devices/ 和 gateway/)
│       ├── data_builder.go            # 测试数据构建器
│       ├── validator.go               # 数据验证器
│       └── logger.go                  # 日志工具
│
├── tests/
│   ├── direct/                        # 直连设备测试
│   │   ├── telemetry_test.go
│   │   ├── attribute_test.go
│   │   ├── event_test.go
│   │   ├── control_test.go
│   │   └── command_test.go
│   │
│   ├── gateway/                       # 网关设备测试
│   │   ├── telemetry_test.go
│   │   ├── attribute_test.go
│   │   ├── event_test.go
│   │   ├── control_test.go
│   │   ├── command_test.go
│   │   └── topology_test.go           # 多级拓扑测试
│   │
│   └── common/                        # 公共测试工具
│       ├── setup.go                   # 测试环境初始化
│       └── helpers.go                 # 测试辅助函数
│
├── testdata/
│   ├── telemetry_samples.json         # 遥测数据样本
│   ├── attribute_samples.json         # 属性数据样本
│   └── event_samples.json             # 事件数据样本
│
├── docs/
│   ├── ThingsPanel-直连设备接入规范.md
│   ├── ThingsPanel-网关设备接入规范.md
│   ├── 相关接口.json
│   ├── 相关表结构.sql
│   └── 环境信息.md
│
├── config-direct.yaml                  # 直连设备配置示例
├── config-gateway.yaml                 # 网关设备配置示例
├── go.mod
├── go.sum
└── README.md
```

---

## 3. 核心模块设计

### 3.1 配置层 (`internal/config/`)

负责从 YAML 文件加载配置信息,支持环境变量覆盖和配置验证。

**配置项分类**:
- 设备类型 (direct 或 gateway)
- MQTT 连接配置 (Broker地址、认证信息、QoS等)
- 设备拓扑信息 (设备ID、设备编号、子设备、子网关)
- 数据库连接配置 (PostgreSQL连接信息)
- API 调用配置 (基础URL、认证密钥、超时时间)
- 测试参数配置 (等待时间、重试次数等)

**配置示例**:
```yaml
device_type: "gateway"  # 或 "direct"

# 直连设备配置
device:
  device_id: "xxx"
  device_number: "device001"
  username: "xxx"
  password: "xxx"
  client_id: "xxx"

# 网关拓扑配置
gateway:
  device_id: "xxx"
  device_number: "gateway001"
  username: "xxx"
  password: "xxx"
  client_id: "xxx"
  sub_devices:
    - sub_device_number: "sensor_01"
      device_id: "xxx"
  sub_gateways:
    - sub_gateway_number: "edge_gateway_001"
      device_id: "xxx"
      sub_devices:
        - sub_device_number: "sub_sensor_01"
          device_id: "xxx"
```

---

### 3.2 设备模拟层 (`internal/device/`)

#### 3.2.1 设备接口 (device.go)

定义统一的设备接口,供直连设备和网关设备实现:
```go
type Device interface {
    Connect() error
    Disconnect()
    PublishTelemetry(data interface{}) error
    PublishAttribute(data interface{}, messageID string) error
    PublishEvent(method string, params interface{}, messageID string) error
    SubscribeDownlink() error
    GetReceivedMessages(messageType string) []Message
}
```

#### 3.2.2 直连设备 (direct_device.go)

实现 Device 接口,处理直连设备的 MQTT 通信:
- 使用 `devices/*` 主题前缀
- 扁平化数据结构
- 单设备上报和订阅

#### 3.2.3 网关设备 (gateway_device.go)

实现 Device 接口,处理网关设备的 MQTT 通信:
- 使用 `gateway/*` 主题前缀
- 嵌套数据结构 (gateway_data/sub_device_data/sub_gateway_data)
- 支持多级拓扑的数据聚合

#### 3.2.4 设备工厂 (factory.go)

根据配置创建相应的设备实例:
```go
func NewDevice(cfg *config.Config) (Device, error)
```

---

### 3.3 协议层 (`internal/protocol/`)

#### 3.3.1 消息构建器接口 (message_builder.go)

定义消息构建规则:
```go
type MessageBuilder interface {
    BuildTelemetry(data interface{}) ([]byte, error)
    BuildAttribute(data interface{}) ([]byte, error)
    BuildEvent(method string, params interface{}) ([]byte, error)
}
```

#### 3.3.2 直连设备消息构建 (direct_builder.go)

构建扁平 JSON 格式:
```json
{"temperature": 28.5, "switch": true}
```

#### 3.3.3 网关设备消息构建 (gateway_builder.go)

构建嵌套 JSON 格式:
```json
{
  "gateway_data": {"temperature": 28.5},
  "sub_device_data": {
    "sensor_01": {"temperature": 27.1}
  },
  "sub_gateway_data": {
    "edge_gateway_001": {
      "gateway_data": {...},
      "sub_device_data": {...}
    }
  }
}
```

---

### 3.4 平台交互层 (`internal/platform/`)

#### 3.4.1 API客户端 (api_client.go)

封装平台 HTTP API 调用:
- 下发遥测控制指令
- 下发属性设置请求
- 请求获取属性数据
- 下发命令

**说明**: 平台 API 接口统一,对子设备/子网关下发指令时使用子设备的 device_number,平台自动封装为网关报文。

#### 3.4.2 数据库客户端 (db_client.go)

封装数据库查询操作:
- 查询遥测数据(历史数据和当前数据)
- 查询属性数据
- 查询事件数据
- 查询各类下发日志(遥测、属性、命令)
- 支持按 device_id 过滤(网关、子设备、子网关)

---

### 3.5 工具层 (`internal/utils/`)

提供通用工具函数:
- 消息ID生成器
- MQTT主题构建器 (支持 devices/ 和 gateway/ 前缀)
- 测试数据构建器(遥测、属性、事件)
- 数据验证器(格式、时间戳、内容匹配)
- 时间戳生成器
- 日志工具

---

## 4. 测试用例设计

**说明**: 测试用例按操作粒度组织,通过配置切换测试直连设备或网关设备。

### 4.1 遥测数据测试
- **直连模式**: 设备上报遥测数据,验证入库
- **网关模式**: 网关上报自身和子设备遥测数据,验证各设备数据正确入库
- **验证点**: `telemetry_datas` 和 `telemetry_current_datas` 表,数据类型、时间戳

### 4.2 属性数据测试
- **直连模式**: 设备上报属性数据
- **网关模式**: 网关、子设备、子网关同时上报属性数据
- **验证点**: `attribute_datas` 表,覆盖更新逻辑

### 4.3 事件数据测试
- **直连模式**: 设备上报事件 (method + params)
- **网关模式**: 多层级设备同时上报不同事件
- **验证点**: `event_datas` 表,JSON 完整性

### 4.4 控制指令测试
- **直连模式**: 平台下发控制指令,设备接收
- **网关模式**: 平台下发到子设备,网关接收并解析嵌套报文
- **验证点**: 设备接收消息,下发日志记录

### 4.5 属性设置测试
- **直连模式**: 平台设置属性,设备响应
- **网关模式**: 平台设置子设备属性,网关代理响应
- **验证点**: 请求-响应流程,响应格式(扁平)

### 4.6 属性获取测试
- **直连模式**: 平台请求属性,设备主动上报
- **网关模式**: 平台请求子设备属性,网关聚合上报
- **验证点**: keys 参数解析,属性数据上报

### 4.7 命令测试
- **直连模式**: 平台下发命令,设备执行并响应
- **网关模式**: 平台下发到子设备,网关转发并汇总响应
- **验证点**: method/params 匹配,响应格式

### 4.8 网关拓扑测试
- 测试多级网关数据聚合
- 测试混合场景(网关 + 子设备 + 子网关)
- 验证嵌套结构正确解析

---

## 5. 技术选型

### 5.1 核心依赖
- `github.com/eclipse/paho.mqtt.golang` - MQTT客户端
- `github.com/lib/pq` - PostgreSQL驱动
- `gopkg.in/yaml.v3` - YAML配置解析
- `github.com/stretchr/testify` - 测试断言
- `github.com/google/uuid` - UUID生成
- `go.uber.org/zap` - 结构化日志

### 5.2 测试框架
- Go 标准测试库
- Table-driven tests 模式
- Testify 断言库

---

## 6. 关键设计决策

### 6.1 统一设备接口
- 直连设备和网关设备实现同一接口
- 通过配置文件 `device_type` 切换测试模式
- 测试用例不关心设备类型,只调用接口方法
- 提高代码复用率,降低维护成本

### 6.2 单连接模式
- 网关测试中只有网关建立 MQTT 连接
- 子设备和子网关数据通过网关连接上报
- 使用嵌套数据结构标识数据来源
- 配置中只需提供网关的 MQTT 认证信息

### 6.3 设备标识统一
- `sub_device_number` 和 `sub_device_address` 是同一概念
- 配置和数据上报都使用 `sub_device_number`
- 子网关使用 `sub_gateway_number`
- 所有设备在平台预先创建并提供 `device_id`

### 6.4 下行指令处理
- 平台对子设备下发指令时,使用子设备 device_number 调用 API
- 平台自动封装为网关嵌套报文
- 网关订阅 `gateway/*/{gateway_device_number}` 主题
- 报文中通过 sub_device_data/sub_gateway_data 标识目标设备

### 6.5 响应格式
- 子设备响应消息使用扁平格式
- 不需要在响应中标识来源设备
- 通过 message_id 和主题关联请求

### 6.6 数据验证策略
- 采用"等待-查询-验证"模式
- 时间戳容差设置为3秒
- 支持重试机制提高可靠性
- 按 device_id 过滤验证不同设备的数据

### 6.7 测试隔离策略
- 使用固定测试设备避免干扰
- 测试前清理历史数据
- 每个测试生成唯一 message_id
- 支持测试后数据清理或保留

---

## 7. 实施路径

### 阶段一: 抽象现有代码
1. 定义 Device 接口和 MessageBuilder 接口
2. 重构现有代码为 DirectDevice 实现
3. 创建设备工厂,支持配置驱动实例化
4. 验证直连设备测试无回归

### 阶段二: 实现网关支持
1. 实现 GatewayDevice 和 GatewayMessageBuilder
2. 实现网关主题构建和嵌套数据处理
3. 扩展配置结构支持拓扑定义
4. 新增网关拓扑测试用例

### 阶段三: 统一测试框架
1. 重构测试用例使用设备接口
2. 支持通过配置切换测试场景
3. 完善网关模式下的数据验证逻辑
4. 补充集成测试和文档

---

## 8. 扩展方向

### 8.1 性能测试
- 并发测试(多设备/多网关同时上报)
- 压力测试(大量数据上报)
- 性能基准测试

### 8.2 稳定性测试
- 网络异常场景测试
- 断线重连测试
- 长时间运行测试

### 8.3 功能扩展
- OTA 升级测试
- 更深层级网关测试(三层及以上)
- 持续集成支持

---

## 9. 参考文档

- [ThingsPanel MQTT 直连设备接入规范](./ThingsPanel-直连设备接入规范.md)
- [ThingsPanel MQTT 网关设备接入规范](./ThingsPanel-网关设备接入规范.md)
- [相关接口文档](./相关接口.json)
- [数据库表结构](./相关表结构.sql)
- [环境信息](./环境信息.md)

