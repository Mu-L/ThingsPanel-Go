# IoT Platform 自动化测试框架设计

## 1. 项目概述

### 1.1 目标
构建一个自动化测试框架,用于验证 ThingsPanel IoT 平台的设备接入、数据上报、指令下发等核心功能。

### 1.2 测试范围
- MQTT 直连设备模拟
- 设备数据上报(遥测、属性、事件)验证
- 平台指令下发(控制、属性设置、命令)验证
- 数据入库验证
- 消息响应验证

---

## 2. 项目结构

```
iot-platform-autotest/
│
├── cmd/
│   └── autotest/
│       └── main.go                    # 主程序入口
│
├── internal/
│   ├── config/
│   │   ├── config.go                  # 配置结构定义
│   │   └── loader.go                  # 配置加载器
│   │
│   ├── device/
│   │   ├── mqtt_device.go             # MQTT设备核心实现
│   │   ├── message_handler.go         # MQTT消息处理器
│   │   └── subscription_manager.go    # 订阅管理器
│   │
│   ├── platform/
│   │   ├── api_client.go              # HTTP API客户端
│   │   └── db_client.go               # 数据库查询客户端
│   │
│   └── utils/
│       ├── mqtt_topics.go             # MQTT主题构建工具
│       ├── data_builder.go            # 测试数据构建器
│       ├── validator.go               # 数据验证器
│       └── logger.go                  # 日志工具
│
├── tests/
│   ├── telemetry_test.go              # 遥测数据测试
│   ├── attribute_test.go              # 属性数据测试
│   ├── event_test.go                  # 事件数据测试
│   ├── control_test.go                # 控制指令测试
│   ├── command_test.go                # 命令测试
│   └── integration_test.go            # 集成测试
│
├── testdata/
│   ├── telemetry_samples.json         # 遥测数据样本
│   ├── attribute_samples.json         # 属性数据样本
│   └── event_samples.json             # 事件数据样本
│
├── docs/
│   ├── 直连设备接入规范.md
│   ├── 相关接口.json
│   ├── 相关表结构.sql
│   └── 环境信息.md
│
├── config.yaml                         # 配置文件
├── config.example.yaml                 # 配置文件示例
├── go.mod
├── go.sum
└── README.md
```

---

## 3. 核心模块设计

### 3.1 配置层 (`internal/config/`)

负责从 YAML 文件加载配置信息,支持环境变量覆盖和配置验证。

**配置项分类**:
- MQTT 连接配置 (Broker地址、认证信息、QoS等)
- 设备标识信息 (设备ID、设备编号)
- 数据库连接配置 (PostgreSQL连接信息)
- API 调用配置 (基础URL、认证密钥、超时时间)
- 测试参数配置 (等待时间、重试次数等)

---

### 3.2 设备模拟层 (`internal/device/`)

#### 3.2.1 MQTT设备核心 (mqtt_device.go)

**核心职责**:
- MQTT连接生命周期管理(连接、断开、状态监控)
- 设备数据上报(遥测、属性、事件)
- 订阅管理(控制指令、属性操作、命令下发)
- 接收消息缓存和验证

**MQTT主题规则**:

上报主题:
- `devices/telemetry` - 遥测数据
- `devices/attributes/{message_id}` - 属性数据
- `devices/event/{message_id}` - 事件数据
- `devices/command/response/{message_id}` - 命令响应
- `devices/attributes/set/response/{message_id}` - 属性设置响应
  
订阅主题:
- `devices/telemetry/control/{device_number}` - 遥测控制
- `devices/attributes/set/{device_number}/+` - 属性设置
- `devices/attributes/get/{device_number}` - 属性获取
- `devices/command/{device_number}/+` - 命令下发
- `devices/attributes/response/{device_number}/+` - 属性响应
- `devices/event/response/{device_number}/+` - 事件响应

#### 3.2.2 消息处理器 (message_handler.go)

负责处理平台下发的各类消息:
- 解析控制指令
- 解析属性设置/获取请求
- 解析命令请求
- 验证消息格式
- 存储接收消息供测试验证

---

### 3.3 平台交互层 (`internal/platform/`)

#### 3.3.1 API客户端 (api_client.go)

封装平台 HTTP API 调用:
- 下发遥测控制指令
- 下发属性设置请求
- 请求获取属性数据
- 下发命令

认证方式: 使用 `x-token` 请求头传递 API Key

#### 3.3.2 数据库客户端 (db_client.go)

封装数据库查询操作:
- 查询遥测数据(历史数据和当前数据)
- 查询属性数据
- 查询事件数据
- 查询各类下发日志(遥测、属性、命令)

---

### 3.4 工具层 (`internal/utils/`)

提供通用工具函数:
- 消息ID生成器
- 测试数据构建器(遥测、属性、事件)
- 数据验证器(格式、时间戳、内容匹配)
- 时间戳生成器
- 日志工具

---

## 4. 测试用例设计

### 4.1 设备上报遥测数据
设备通过 MQTT 上报遥测数据,验证数据正确入库到 `telemetry_datas` 和 `telemetry_current_datas` 表,检查数据类型、时间戳和平台响应。

### 4.2 设备上报属性数据
设备上报属性数据并携带 message_id,验证数据入库到 `attribute_datas` 表,确认同一设备同一key的数据会被覆盖更新。

### 4.3 设备上报事件数据
设备上报事件数据(method + params),验证完整入库到 `event_datas` 表,检查 JSON 数据完整性。

### 4.4 平台下发控制指令
平台通过 API 下发遥测控制指令,验证设备能够接收到消息,检查下发日志记录。

### 4.5 平台下发属性设置
平台下发属性设置请求,设备接收后回复响应,验证完整的请求-响应流程和日志记录。

### 4.6 平台请求获取属性
平台请求获取设备属性,设备接收keys参数后主动上报对应属性数据。

### 4.7 平台下发命令
平台下发命令(method + params),设备接收处理后回复响应,验证 Identify 字段匹配和响应格式。

---

## 5. 技术选型

### 5.1 核心依赖
- `github.com/eclipse/paho.mqtt.golang` - MQTT客户端
- `github.com/lib/pq` - PostgreSQL驱动
- `gopkg.in/yaml.v3` - YAML配置解析
- `github.com/stretchr/testify` - 测试断言
- `github.com/google/uuid` - UUID生成
- `go.uber.org/zap` - 结构化日志

### 5.2 测试框架
- Go 标准测试库
- Table-driven tests 模式
- Testify 断言库

---

## 6. 关键设计决策

### 6.1 消息ID生成策略
使用毫秒时间戳后7位作为消息ID,确保短期内唯一性,便于调试和追踪。

### 6.2 数据验证策略
采用"等待-查询-验证"模式:
- 设置固定等待时间让数据同步
- 查询数据库验证入库情况
- 支持重试机制提高可靠性
- 时间戳容差设置为3秒

### 6.3 测试隔离策略
- 使用固定测试设备避免干扰
- 测试前清理历史数据
- 每个测试生成唯一 message_id
- 支持测试后数据清理或保留

### 6.4 错误处理策略
- 所有错误必须记录日志
- 关键步骤失败立即终止测试
- 提供详细的错误上下文信息
- 支持错误重试机制

---

## 7. 扩展方向

### 7.1 性能测试
- 并发测试(多设备同时上报)
- 压力测试(大量数据上报)
- 性能基准测试

### 7.2 稳定性测试
- 网络异常场景测试
- 断线重连测试
- 长时间运行测试

### 7.3 功能扩展
- OTA 升级测试
- 网关子设备测试
- 持续集成支持

---

## 8. 参考文档

- [ThingsPanel MQTT 设备接入规范](./直连设备接入规范.md)
- [相关接口文档](./相关接口.json)
- [数据库表结构](./相关表结构.sql)
- [环境信息](./环境信息.md)

