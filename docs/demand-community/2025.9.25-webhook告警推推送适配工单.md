# webhook告警推送适配工单

## 当前系统webhook通知的实现

当前webhook服务收到的推送数据格式：

```json
{
  "subject": "[ALERT] webhook测试 [H]",
  "content": "Alert: webhook测试\nLevel: H\nTime: 2025-09-11 22:59:20\nDescription: 鱼塘高温预警！\nDetails: 场景自动化触发告警;设备(webhook测试)遥测 [test_data1]: 8 > 1",
  "timestamp": "2025-09-11T22:59:20+08:00"
}
```

### 字段说明
- `subject`: 告警标题，格式为 `[ALERT] {告警名称} [{告警级别}]`
- `content`: 告警详细内容，包含告警信息、级别、时间、描述和详情
- `timestamp`: 告警触发时间戳，RFC3339格式

目前推送过去的信息缺少触发该告警相关的设备ID和设备所属的租户管理员ID，这是创建工单的必备条件。
所以如果是设备触发的告警 需要有该信息

## 当前实现分析

### 可用数据源
根据代码分析，当前告警系统有以下可用数据：

#### 1. AlarmConfig（告警配置）
- `ID`: 告警配置ID
- `Name`: 告警名称  
- `AlarmLevel`: 告警级别 (H/M/L)
- `TenantID`: 租户ID
- `Description`: 告警描述
- `NotificationGroupID`: 通知组ID

#### 2. AlarmExecute方法参数
- `alarmConfigID`: 告警配置ID
- `content`: 告警详细内容
- `scene_automation_id`: 场景自动化ID（可选）
- `group_id`: 设备组ID（可选）  
- `device_ids`: 触发告警的设备ID列表

#### 3. 租户管理员信息获取
可通过 `TenantID` 查询 `users` 表获取：
- 条件：`tenant_id = ? AND authority = 'TENANT_ADMIN'`
- 返回：租户管理员用户信息

### 问题分析
当前webhook推送的JSON结构不完整：
```json
{
  "subject": "[ALERT] webhook测试 [H]", 
  "content": "Alert: webhook测试\nLevel: H\nTime: 2025-09-11 22:59:20...",
  "timestamp": "2025-09-11T22:59:20+08:00"
}
```

缺少工单系统需要的关键字段：
- 设备ID列表
- 租户ID  
- 租户管理员ID

## 改造设计

### 新的webhook推送结构
```json
{
  "subject": "[ALERT] webhook测试 [H]",
  "content": "Alert: webhook测试\nLevel: H\nTime: 2025-09-11 22:59:20\nDescription: 鱼塘高温预警！\nDetails: 场景自动化触发告警;设备(webhook测试)遥测 [test_data1]: 8 > 1",
  "timestamp": "2025-09-11T22:59:20+08:00",
  "alarm_level": "H",
  "tenant_id": "tenant_uuid_here", 
  "tenant_admin_id": "user_uuid_here",
  "device_ids": ["device_uuid_1", "device_uuid_2"]
}
```

### 字段说明
| 字段 | 类型 | 说明 | 是否必须 |
|------|------|------|----------|
| subject | string | 告警标题 | 是 |
| content | string | 告警详细内容 | 是 |  
| timestamp | string | 告警时间戳(RFC3339格式) | 是 |
| alarm_level | string | 告警级别(H/M/L) | 是 |
| tenant_id | string | 租户ID | 是 |
| tenant_admin_id | string | 租户管理员ID | 是 |
| device_ids | array | 触发告警的设备ID列表 | 否* |

*注：device_ids在设备触发的告警中为必须字段

### 实现方案

#### 1. 修改AlarmExecute方法
在 `internal/service/alarm.go` 的 `AlarmExecute` 方法中：

```go
// 获取租户管理员ID
var tenantAdminID string
if tenantAdmin, err := dal.GetTenantAdmin(alarmConfig.TenantID); err == nil && tenantAdmin != nil {
    tenantAdminID = tenantAdmin.ID
}

// 构建增强的告警JSON
alertData := map[string]interface{}{
    "subject":         subject,
    "content":         notificationContent, 
    "timestamp":       time.Now().Format(time.RFC3339),
    "alarm_level":     alarmConfig.AlarmLevel,
    "tenant_id":       alarmConfig.TenantID,
    "tenant_admin_id": tenantAdminID,
    "device_ids":      device_ids,
}
```

#### 2. 新增DAL方法
在 `internal/dal/users.go` 中添加：

```go
// GetTenantAdmin 获取租户管理员
func GetTenantAdmin(tenantID string) (*model.User, error) {
    q := query.User
    return q.Where(q.TenantID.Eq(tenantID)).
        Where(q.Authority.Eq("TENANT_ADMIN")).
        Where(q.Status.Eq("N")).
        First()
}
```

#### 3. 修改AddAlarmInfo方法
同样需要增强 `AddAlarmInfo` 方法的JSON结构，但由于该方法没有device_ids参数，对应字段为空数组。

### 向后兼容性
为保证向后兼容：
- 保留原有的subject、content、timestamp字段
- 新增字段作为扩展信息
- 接收方可按需使用新字段，忽略不需要的字段

### 测试验证  
1. **设备告警测试**：触发设备告警，验证device_ids字段正确
2. **租户管理员测试**：验证tenant_admin_id字段正确获取  
3. **向后兼容测试**：验证现有webhook接收方正常工作