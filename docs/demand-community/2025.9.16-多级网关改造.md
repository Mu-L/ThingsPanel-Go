# 多级网关改造方案（支持遥测 / 属性 / 事件 / 命令）


## 1. 改造背景


原规范仅支持**单层网关 → 普通子设备**的数据结构。

新需求要求支持**网关下挂载子网关（Sub Gateway）**，子网关下可继续挂载普通子设备，实现多级网关拓扑。

改造后，所有四类交互数据（遥测、属性、事件、命令）均需支持多级结构。


----

## 2. API 改动点


|API|原功能|改造后功能|
|:-:|:-:|:-:|
|`GET /api/v1/device/selector`|返回未绑定的子设备|返回未绑定的子设备和未绑定的网关设备|
|`PUT /api/v1/device_config/batch`|批量绑定子设备到网关|支持批量绑定网关设备到网关设备（多级绑定）|


----

## 3. 数据结构改造


### 3.1 新增节点


- **`sub_gateway_data`**：表示挂载在当前网关下的子网关集合
	- key：子网关设备编号
	- value：包含该子网关的 `gateway_data`（自身数据）和 `sub_device_data`（直接挂载的普通子设备数据），以及可选的 `sub_gateway_data`（继续嵌套的子网关）


----

### 3.2 遥测上报（Telemetry）


#### 旧版（单层）


```
{
  "gateway_data": { "temperature": 28.5, "version": "v0.1", "switch": true },
  "sub_device_data": {
    "28da4985": { "temperature": 28.5, "version": "v0.1", "switch": true }
  }
}
```
#### 新版（多级）


```
{
  "gateway_data": { "temperature": 26.8, "version": "v1.0", "switch": true },
  "sub_device_data": {
    "direct_device_001": { "temperature": 25.0, "version": "v1.0" }
  },
  "sub_gateway_data": {
    "edge_gateway_001": {
      "gateway_data": { "temperature": 28.5, "version": "v0.1", "switch": true },
      "sub_device_data": {
        "28da4985": { "temperature": 28.5, "version": "v0.1", "switch": true }
      }
    }
  }
}
```


----

### 3.3 属性上报（Attributes）


#### 新版（多级）


```
{
  "gateway_data": { "ip": "127.0.0.1", "version": "v1.0" },
  "sub_device_data": {
    "direct_device_001": { "ip": "127.0.0.1", "version": "v1.0" }
  },
  "sub_gateway_data": {
    "edge_gateway_001": {
      "gateway_data": { "ip": "192.168.1.10", "version": "v0.1" },
      "sub_device_data": {
        "28da4985": { "ip": "192.168.1.11", "version": "v0.1" }
      }
    }
  }
}
```


----

### 3.4 事件上报（Event）


#### 新版（多级）


```
{
  "gateway_data": {
    "method": "FindAnimal",
    "params": { "count": 2, "animalType": "cat" }
  },
  "sub_device_data": {
    "direct_device_001": {
      "method": "FindAnimal",
      "params": { "count": 1, "animalType": "dog" }
    }
  },
  "sub_gateway_data": {
    "edge_gateway_001": {
      "gateway_data": {
        "method": "FindAnimal",
        "params": { "count": 3, "animalType": "bird" }
      },
      "sub_device_data": {
        "28da4985": {
          "method": "FindAnimal",
          "params": { "count": 2, "animalType": "cat" }
        }
      }
    }
  }
}
```


----

### 3.5 控制 / 属性设置 / 获取属性 / 命令下发


所有下行消息（平台 → 设备）结构与上行保持一致：


- **`gateway_data`**：当前网关自身的控制/属性/命令

- **`sub_device_data`**：直接挂载的普通子设备的控制/属性/命令

- **`sub_gateway_data`**：子网关及其下属设备的控制/属性/命令（可递归）


----

## 4. 主题与兼容性


- 上报主题保持不变：
	- `gateway/telemetry`
	- `gateway/attributes/{message_id}`
	- `gateway/event/{message_id}`

- 下发主题保持不变：
	- `gateway/telemetry/control/{device_number}`
	- `gateway/attributes/set/{device_number}/+`
	- `gateway/command/{device_number}/+`

- **兼容性**：旧版设备不包含 `sub_gateway_data` 节点，平台需兼容解析。


----


