# 接入服务认证接口限流

## 问题背景

**业务流程**: 设备 → 设备接入服务 → 平台

**问题现象**: 部分设备在认证失败后会立即无间隔重试，导致：
- 平台持续输出大量错误日志
- 数据库频繁查询，增加系统负载
- 影响系统整体性能和稳定性

## 目标接口

- **接口路径**: `/api/v1/plugin/device/config`
- **请求方法**: POST
- **接口功能**: 协议插件获取设备配置认证
- **认证参数**: device_id、voucher、device_number（三选一）
- **代码位置**: `internal/api/protocol_plugin.go:106`

## 解决方案

### 限流策略
- **限流维度**: 基于设备唯一标识符（voucher/device_number，不包含device_id）
- **限流算法**: 令牌桶算法（复用现有AutomateLimiter）
- **限流规则**: 每3秒最多允许1次认证请求
- **超限处理**: 返回HTTP 429状态码和现有错误码格式

### 技术实现
- **存储方案**: 复用现有Redis实例（db: 1）
- **算法实现**: 基于现有AutomateLimiter扩展
- **配置管理**: 使用全局常量，无需配置文件
- **中间件集成**: 创建设备认证专用限流中间件
- **错误处理**: 集成现有errcode错误码体系

### 预期效果
- 有效防止设备频繁重试造成的系统负载
- 减少错误日志输出和数据库查询压力
- 保证正常设备认证不受影响
- 提升系统整体稳定性和性能