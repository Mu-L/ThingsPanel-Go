# 数据处理和流转模块改造设计

## 当前实现分析

### 现有流程

```
MQTT消息接入 → 消息处理 → 数据解析 → 业务处理 → 数据存储
```

### 主要模块

**1. MQTT连接管理**
- 建立MQTT客户端连接
- 订阅设备主题
- 接收消息

**2. 消息处理**
- 解析MQTT消息
- 提取设备信息
- 数据格式转换

**3. 业务逻辑**
- 设备协议解析
- 数据校验
- 规则引擎处理

**4. 数据存储**
- 写入时序数据库
- 写入业务数据库
- 事件记录

### 存在的问题

1. MQTT连接、消息解析、业务处理、数据存储代码混在一起
2. 难以替换MQTT为其他接入方式(如Kafka)
3. 处理逻辑与存储逻辑耦合
4. 扩展新功能需要修改多处代码
5. 测试困难,无法单独测试各个环节

---

## 改造方案

### 分层架构设计

```
┌─────────────────────────────────────────┐
│         应用层 (Application)             │
│     API 接口、设备管理、配置管理          │
└─────────────────────────────────────────┘
                   ↑
                   │ 查询/配置
                   ↓
┌─────────────────────────────────────────┐
│       服务编排层 (Orchestration)         │
│    统一消息处理、路由分发、流程控制       │
└─────────────────────────────────────────┘
                   ↑
                   │ 统一消息格式(storage.Message)
                   ↓
┌─────────────────────────────────────────┐
│        接入适配层 (Adapter)              │
│   MQTT适配器 | Kafka适配器 | HTTP适配器  │
└─────────────────────────────────────────┘
                   ↑
                   │
          各种协议和数据源
```

### 已完成模块

#### ✅ Storage 存储层 (已实现)

**位置**: `internal/storage/`

**职责**:
- 接收统一格式的消息
- 批量写入遥测数据
- 直接写入属性和事件数据
- 提供监控指标

**使用方式**:
```go
// 1. 在 main.go 中添加
app.NewApplication(
    // ...existing options...
    app.WithStorageService(),
)

// 2. 获取 storage 输入 channel
inputChan := application.GetStorageInputChan()

// 3. 发送消息
inputChan <- &storage.Message{
    DeviceID:  "device-001",
    TenantID:  "tenant-001",
    DataType:  storage.DataTypeTelemetry,
    Timestamp: time.Now().UnixMilli(),
    Data: []storage.TelemetryDataPoint{
        {Key: "temperature", Value: 25.5},
        {Key: "humidity", Value: 60.0},
    },
}
```

**特性**:
- ✅ 遥测数据批量写入（500条或1秒触发）
- ✅ 批次内去重
- ✅ UPSERT处理跨批次重复
- ✅ 失败降级为逐条写入
- ✅ 完整的监控指标
- ✅ 优雅关闭





