# 主题构造位置变更设计

## 一、背景

当前Topic构造逻辑分散在Service层和配置文件中，存在以下问题：
1. Service层直接使用`config.MqttConfig.Telemetry.PublishTopic`构造MQTT Topic
2. 违反分层架构：Service层不应感知具体协议（MQTT/Kafka等）
3. 扩展性差：新增协议需要修改Service层代码

## 二、设计目标

1. **协议无关**：Service层不感知具体协议和Topic规则
2. **关注点分离**：Topic构造逻辑下沉到Adapter层
3. **易于扩展**：支持多种协议（MQTT、Kafka、AMQP等）

## 三、架构设计

### 3.1 分层职责

```
Service层
  ├─ 业务逻辑（网关payload构造）
  ├─ 传递设备信息（不传Topic）
  └─ 发送到Downlink Bus

Downlink Handler
  ├─ 脚本编码（Processor.Encode）
  └─ 调用MessagePublisher发送

Adapter层
  ├─ 根据设备信息构造Topic
  └─ 发送到具体协议（MQTT/Kafka）
```

### 3.2 数据结构

#### Message 结构体
```go
type Message struct {
    DeviceID       string      // 设备ID
    DeviceNumber   string      // 目标设备编号（网关/子设备时为顶层网关编号）
    DeviceType     string      // 设备类型："1"=直连,"2"=网关,"3"=子设备
    DeviceConfigID string      // 设备配置ID
    Type           MessageType // 消息类型：Telemetry/Command/Attribute
    Data           []byte      // 消息内容
    MessageID      string      // 消息ID（日志关联）
    TopicPrefix    string      // 协议插件Topic前缀（MQTT为空）
}
```

#### MessagePublisher 接口
```go
type MessagePublisher interface {
    // PublishMessage 发布消息到设备
    // deviceNumber: 目标设备编号
    // msgType: 消息类型（用于选择Topic路径）
    // deviceType: 设备类型（用于区分devices/*还是gateway/*）
    // topicPrefix: Topic前缀（协议插件使用）
    // qos: 消息质量等级
    // payload: 消息内容
    PublishMessage(
        deviceNumber string,
        msgType MessageType,
        deviceType string,
        topicPrefix string,
        qos byte,
        payload []byte,
    ) error
}
```

### 3.3 Topic构造规则

#### MQTT协议Topic规范

**直连设备 (deviceType="1")**:
- 遥测控制: `devices/telemetry/control/{device_number}`
- 命令下发: `devices/command/{device_number}`
- 属性设置: `devices/attributes/set/{device_number}`

**网关/子设备 (deviceType="2"或"3")**:
- 遥测控制: `gateway/telemetry/control/{top_gateway_number}`
- 命令下发: `gateway/command/{top_gateway_number}`
- 属性设置: `gateway/attributes/set/{top_gateway_number}`

**协议插件**:
- 在标准Topic前加前缀: `{topic_prefix}{standard_topic}`
- 示例: `plugin/modbus/devices/telemetry/control/device123`

#### Adapter实现逻辑
```go
func (a *MQTTAdapter) PublishMessage(...) error {
    // 1. 根据设备类型选择Topic基础路径
    basePattern := "devices"
    if deviceType != "1" {
        basePattern = "gateway"
    }

    // 2. 根据消息类型选择Topic路径
    var topicPath string
    switch msgType {
    case MessageTypeTelemetry:
        topicPath = "telemetry/control"
    case MessageTypeCommand:
        topicPath = "command"
    case MessageTypeAttributeSet:
        topicPath = "attributes/set"
    }

    // 3. 拼接完整Topic
    topic := fmt.Sprintf("%s%s/%s/%s",
        topicPrefix, basePattern, topicPath, deviceNumber)

    // 4. 发送
    return a.client.Publish(topic, qos, payload)
}
```

## 四、Service层改动

### 4.1 移除Topic构造

**改动前**:
```go
// ❌ Service层构造MQTT Topic
topic := fmt.Sprintf("%s%s", config.MqttConfig.Telemetry.PublishTopic, deviceInfo.DeviceNumber)

msg := &downlink.Message{
    Topic: topic,
    // ...
}
```

**改动后**:
```go
// ✅ Service层只传设备信息
var topicPrefix string
if protocolType != "MQTT" {
    topicPrefix, _ = dal.GetServicePluginSubTopicPrefixByDeviceConfigID(...)
}

// 确定目标设备编号
var targetDeviceNumber string
switch deviceType {
case "1":
    targetDeviceNumber = deviceInfo.DeviceNumber
case "2", "3":
    topGateway, _ := findTopLevelGateway(deviceInfo, deviceType)
    targetDeviceNumber = topGateway.DeviceNumber
}

msg := &downlink.Message{
    DeviceNumber: targetDeviceNumber,
    DeviceType:   deviceType,
    TopicPrefix:  topicPrefix,
    // ...
}
```

### 4.2 网关Payload构造保留

网关/子设备的payload嵌套构造逻辑保留在Service层：
- `buildNestedSubGatewayData()` - 构造多层网关嵌套数据
- 在脚本处理之前执行
- 保持业务逻辑在Service层

## 五、改动文件清单

| 文件 | 改动内容 |
|-----|---------|
| `internal/downlink/types.go` | Message结构体新增3个字段 |
| `internal/downlink/interfaces.go` | MessagePublisher接口改签名 |
| `internal/downlink/handler.go` | 调用Publisher传新参数 |
| `internal/adapter/mqttadapter/adapter.go` | 实现新接口，内部构造Topic |
| `internal/adapter/mqttadapter/topics.go` | 完善Topic构造函数 |
| `internal/service/telemetry_data.go` | 移除Topic构造，传设备信息 |
| `internal/service/command_data.go` | 移除Topic构造，传设备信息 |
| `internal/service/attribute_data.go` | 移除Topic构造，传设备信息 |

## 六、兼容性

- 配置文件`configs/conf.yml`中的Topic配置暂时保留
- 后续版本统一清理，完全移除配置中的Topic定义
- 现有MQTT通信功能不受影响
