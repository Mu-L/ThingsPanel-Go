# 手机号验重需求

## 需求描述

在用户注册或修改手机号时，需要进行手机号重复性校验，确保同一个手机号不能被多个用户使用。

## 业务场景

1. **用户注册时** - 新用户注册时输入的手机号不能与现有用户重复
2. **修改手机号时** - 用户修改个人信息中的手机号时，新手机号不能与其他用户重复
3. **管理员创建/修改用户时** - 管理员操作用户信息时也需要进行手机号验重

## 相关接口

| 接口路径 | 方法 | 说明 | 文件位置 |
|---------|------|------|----------|
| `/api/v1/user` | POST | 管理员创建用户 | internal/api/sys_user.go:CreateUser |
| `/api/v1/user` | PUT | 管理员修改用户信息 | internal/api/sys_user.go:UpdateUser |
| `/api/v1/user/update` | PUT | 用户修改个人信息 | internal/api/sys_user.go:UpdateUsers |
| `/api/v1/board/user/update` | POST | 看板用户信息更新 | internal/api/board.go:UpdateUserInfo |
| `/api/v1/tenant/email/register` | POST | 租户邮箱注册 | internal/api/sys_user.go:EmailRegister |

## 当前代码状况

### 数据库层面 (DAL)
- 用户表结构已包含 `phone_number` 字段
- 已有通过手机号查询用户的方法: `GetUsersByPhoneNumber`
- 支持多种手机号格式（+86前缀等）

### 服务层面 (Service)
- 各个用户相关接口均使用手机号字段
- **缺少手机号重复性校验逻辑**

### 模型层面 (Model)
- 请求模型已包含手机号字段验证
- `CreateUserReq.PhoneNumber` - 必填字段
- `UpdateUserReq.PhoneNumber` - 可选字段
- `EmailRegisterReq.PhoneNumber` - 必填字段

## 技术实现方案

### 1. 数据访问层 (DAL)
新增手机号存在性检查方法，考虑手机号格式兼容性：
```go
// 检查手机号是否已存在（支持排除指定用户ID）
// 使用LIKE匹配，兼容带/不带国家代码的格式
func CheckPhoneNumberExists(phoneNumber string, excludeUserID ...string) (bool, error)
```

**兼容性处理逻辑：**
- 对于输入的手机号，生成多种可能的格式进行匹配
- 例如：输入 `18211111111` 需要匹配 `18211111111`、`+86 18211111111`、`+8618211111111`
- 例如：输入 `+86 18211111111` 需要匹配 `18211111111`、`+86 18211111111`、`+8618211111111`
- 使用 LIKE 或 OR 条件进行模糊匹配

### 2. 服务层 (Service)
在相关用户操作方法中添加手机号验重逻辑：
- `CreateUser` - 创建前验重
- `UpdateUser` - 更新前验重（排除自己）
- `UpdateUserInfo` - 个人信息更新前验重
- `EmailRegister` - 注册前验重

**注意：不修改现有接口模型，保持接口兼容性**

### 3. 错误处理
- 添加手机号重复的错误码
- 返回友好的错误提示信息

## 测试用例

### 1. **正常场景**
   - 使用未被占用的手机号创建/更新用户
   
### 2. **异常场景**
   - 使用已存在的手机号创建新用户
   - 修改手机号为其他用户已使用的号码
   - 用户修改自己的手机号为相同值（应允许）

### 3. **兼容性场景**
   - 数据库中存在 `18211111111`，用户注册 `+86 18211111111` → 应提示重复
   - 数据库中存在 `+86 18211111111`，用户注册 `18211111111` → 应提示重复
   - 数据库中存在 `+8618211111111`，用户注册 `18211111111` → 应提示重复

## 影响范围

- **数据访问层**: 新增手机号验重方法（包含格式兼容性处理）
- **服务层**: 5个相关接口需要添加验重逻辑
- **错误码**: 新增手机号重复错误码
- **前端**: 需要处理新的错误提示
- **现有接口**: 保持完全兼容，不修改任何模型结构

## 开发优先级

高优先级 - 涉及数据一致性和用户体验