# 需求变更说明

## 文档信息
- **创建日期**：2025-10-26
- **变更类型**：功能新增、功能优化
- **影响模块**：设备管理、遥测数据

## 背景说明

### 相关数据表
- `device_templates`：设备物模型表
- `device_configs`：设备模板表
- `devices`：设备表

### 实体关系
- 一个物模型关联多个设备模板
- 一个设备模板关联多个设备

---

## 需求清单

### 1. 新增：设备物模型统计接口

**需求描述**
提供设备物模型关联设备的统计信息，包括设备总数和在线设备数。

**接口信息**
- 接口路径：待定（建议：`/api/v1/device/template/stats`）
- 请求方式：GET
- 接口类型：新增接口

**功能要点**
- 统计指定物模型关联的设备总数
- 统计指定物模型关联的在线设备数

**查询参数**
- 物模型ID（必填）

**返回字段**
- 物模型ID
- 物模型名称
- 标签
- 关联设备总数
- 在线设备数

---

### 2. 新增：设备物模型选择器接口

**需求描述**
提供不分页的设备物模型列表，用于下拉选择器、筛选条件等场景。

**接口信息**
- 接口路径：待定（建议：`/api/v1/device/template/selector`）
- 请求方式：GET
- 接口类型：新增接口

**功能要点**
- 不分页，返回所有符合条件的物模型
- 支持物模型名称模糊匹配
- 支持标签模糊匹配
- 支持物模型ID精确查询

**查询参数**
- 物模型名称（模糊匹配）
- 标签（模糊匹配）
- 物模型ID（精确匹配）

**返回字段**
- 物模型ID
- 物模型名称

---

### 3. 优化：设备列表增加物模型过滤

**需求描述**
在现有设备列表查询接口中，增加按设备物模型ID过滤的功能。

**接口信息**
- 接口路径：`/api/v1/device`
- 请求方式：GET
- 接口类型：功能优化

**功能要点**
- 在现有查询参数基础上，新增物模型ID过滤条件
- 支持按单个物模型ID进行筛选
- 与现有其他查询条件可组合使用

**新增查询参数**
- 设备物模型ID（可选）

---

### 4. 优化：遥测数据时间戳精度提升

**需求描述**
将遥测数据导出功能中的时间字段精度从秒级提升到毫秒级。

**接口信息**
- 接口路径：`/api/v1/telemetry/datas/history/pagination`
- 请求方式：GET
- 接口类型：功能优化

**功能要点**
- 时间字段显示精确到毫秒
- 确保导出数据的时间格式统一
- 不影响现有时间查询和过滤功能

**优化内容**
- 返回数据的时间戳字段增加毫秒精度
- 导出文件中的时间格式调整为包含毫秒

---

## 技术提示

### 涉及代码模块
- API层：`internal/api/device.go`、`internal/api/telemetry_data.go`
- Service层：`internal/service/device.go`、`internal/service/telemetry_data.go`
- DAL层：`internal/dal/devices.go`、`internal/dal/device_template.go`
- Model层：`internal/model/devices.http.go`、`internal/model/device_templates.http.go`
- Router层：`router/apps/device.go`、`router/apps/telemetry_data.go`

### 注意事项
1. 新增接口需要在router层注册路由
2. 时间精度修改需确保前后端格式一致
3. 所有接口需要添加权限控制和参数校验
