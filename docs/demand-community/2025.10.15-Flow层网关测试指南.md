# Flow层网关消息测试指南

## 测试前检查清单

### 1. 配置检查
确认 `configs/conf.yml` 中 Flow 已启用:
```yaml
flow:
  enable: true                     # 必须为 true
  bus_buffer_size: 1000           # Bus消息总线缓冲区大小
```

### 2. 日志级别设置
为了看到详细的调试日志,设置日志级别为 DEBUG:
```yaml
system:
  log_level: debug  # 或者 info
```

### 3. 重启服务
修改配置后需要重启服务才能生效。

## 测试步骤

### 测试1: 网关遥测上报

#### 1.1 准备测试数据
使用 MQTT 客户端发送消息到主题: `gateway/telemetry/{gateway_device_id}`

Payload (需要先包装成标准格式):
```json
{
  "device_id": "16df85ab-a749-5a35-04d0-8bc8819ba825",
  "values": "{\"gateway_data\":{\"switch\":1},\"sub_gateway_data\":{\"47ac607c\":{\"gateway_data\":{\"temperature\":28.5,\"version\":\"v0.1\",\"switch\":true},\"sub_device_data\":{\"1d651702\":{\"temperature\":28.3}}}}}"
}
```

#### 1.2 观察日志输出
查找以下关键日志:

**1. Adapter层日志:**
```
level=debug msg="Gateway telemetry routing to Flow layer" topic="gateway/telemetry/xxx"
level=debug msg="Telemetry message published to bus via Flow layer" device_id=xxx is_gateway=true msg_type=gateway_telemetry
```

**2. Flow层日志:**
```
level=debug msg="Processing gateway message" device_id=xxx
level=debug msg="Processing sub device" device_id=xxx parent_id=xxx
level=debug msg="Processing sub gateway" device_id=xxx parent_id=xxx depth=1
```

**3. Storage层日志:**
```
level=info msg="Telemetry data stored" device_id=xxx tenant_id=xxx points=N
```

#### 1.3 验证数据库
检查 `telemetry_datas` 表:
```sql
-- 网关自身数据
SELECT * FROM telemetry_datas 
WHERE device_id = '16df85ab-a749-5a35-04d0-8bc8819ba825' 
ORDER BY ts DESC LIMIT 1;

-- 子网关数据
SELECT * FROM telemetry_datas 
WHERE device_id IN (
  SELECT id FROM devices WHERE sub_device_addr = '47ac607c'
) 
ORDER BY ts DESC LIMIT 1;

-- 子设备数据
SELECT * FROM telemetry_datas 
WHERE device_id IN (
  SELECT id FROM devices WHERE sub_device_addr = '1d651702'
) 
ORDER BY ts DESC LIMIT 1;
```

### 测试2: 网关属性上报

#### 2.1 发送消息
主题: `gateway/attributes/{gateway_device_id}`

Payload:
```json
{
  "device_id": "16df85ab-a749-5a35-04d0-8bc8819ba825",
  "values": "{\"gateway_data\":{\"online_status\":\"online\",\"signal_strength\":85},\"sub_gateway_data\":{\"47ac607c\":{\"gateway_data\":{\"location\":\"Building A-2F\",\"firmware_version\":\"v1.2.3\",\"online_status\":\"online\"},\"sub_device_data\":{\"1d651702\":{\"battery_level\":78,\"location\":\"Room 201\"}}}}}"
}
```

#### 2.2 验证数据库
检查 `attribute_datas` 表:
```sql
SELECT device_id, key, value, ts 
FROM attribute_datas 
WHERE device_id IN (
  '16df85ab-a749-5a35-04d0-8bc8819ba825',
  (SELECT id FROM devices WHERE sub_device_addr = '47ac607c'),
  (SELECT id FROM devices WHERE sub_device_addr = '1d651702')
)
ORDER BY ts DESC;
```

### 测试3: 网关事件上报

#### 3.1 发送消息
主题: `gateway/event/{gateway_device_id}`

Payload:
```json
{
  "device_id": "16df85ab-a749-5a35-04d0-8bc8819ba825",
  "values": "{\"gateway_data\":{\"method\":\"SystemAlert\",\"params\":{\"alert_type\":\"system_start\",\"timestamp\":1726581600,\"message\":\"Gateway system started successfully\"}},\"sub_gateway_data\":{\"47ac607c\":{\"gateway_data\":{\"method\":\"TemperatureAlert\",\"params\":{\"temperature\":35.2,\"threshold\":30.0,\"timestamp\":1726581650,\"severity\":\"warning\"}},\"sub_device_data\":{\"1d651702\":{\"method\":\"BatteryAlert\",\"params\":{\"battery_level\":18,\"threshold\":20,\"timestamp\":1726581700,\"status\":\"low_battery\"}}}}}}"
}
```

#### 3.2 验证数据库
检查 `event_datas` 表:
```sql
SELECT device_id, identify, data, ts 
FROM event_datas 
WHERE device_id IN (
  '16df85ab-a749-5a35-04d0-8bc8819ba825',
  (SELECT id FROM devices WHERE sub_device_addr = '47ac607c'),
  (SELECT id FROM devices WHERE sub_device_addr = '1d651702')
)
ORDER BY ts DESC;
```

## 常见问题排查

### 问题1: 日志显示 "using legacy processing"
**原因:** `mqttAdapter` 未注册或为 nil

**排查步骤:**
1. 检查 `flow.enable` 配置是否为 `true`
2. 查找日志中是否有 `"MQTT Adapter registered for Flow layer"`
3. 检查 `WithFlowService()` 是否在 `WithMQTTService()` 之前调用
4. 重启服务

### 问题2: 日志显示走了Flow层但数据未拆分
**原因:** Topic判断逻辑错误或消息类型未正确识别

**排查步骤:**
1. 检查日志中的 `msg_type` 字段,应该是 `gateway_telemetry/gateway_attribute/gateway_event`
2. 检查 Topic 格式是否正确: `gateway/{type}/{device_id}`
3. 确认 `detectMessageType()` 逻辑正确

### 问题3: 网关自身数据有,但子设备数据缺失
**原因:** 
- 子设备地址(sub_device_addr)不匹配
- 子设备未在数据库中注册
- 脚本处理后 Payload 格式不正确

**排查步骤:**
1. 检查数据库中子设备的 `sub_device_addr` 字段
2. 查找日志中 "Sub device not found" 警告
3. 验证脚本处理后的 Payload 是否符合 `GatewayPublish` 结构

### 问题4: 多层网关只处理了第一层
**原因:** 递归深度限制或子网关数据结构错误

**排查步骤:**
1. 检查是否有 "Maximum gateway depth (5) exceeded" 日志
2. 验证 `sub_gateway_data` 的嵌套结构是否正确
3. 查看 `processSubGateways()` 的调用栈

## 性能验证

### 并发测试
使用MQTT压测工具发送大量网关消息,验证:
- Bus缓冲区是否溢出
- Storage写入是否及时
- 内存使用是否稳定
- CPU使用率是否合理

### 建议指标
- Bus消息处理延迟: < 10ms
- Storage写入延迟: < 50ms (批量) / < 10ms (直写)
- 网关拆分性能: 单条消息拆分10个子设备 < 5ms
- 内存使用: 增长稳定,无泄漏

## 成功标志

✅ 日志中显示 "routing to Flow layer"
✅ 日志中显示 `msg_type=gateway_*` 
✅ 网关自身数据正确入库
✅ 子设备数据正确拆分并入库
✅ 多层网关(最多5层)正确递归处理
✅ 心跳更新正常
✅ 场景联动触发正常

## 测试命令示例

### 使用 mosquitto_pub 测试
```bash
# 网关遥测
mosquitto_pub -h localhost -t "gateway/telemetry/16df85ab-a749-5a35-04d0-8bc8819ba825" \
  -m '{"device_id":"16df85ab-a749-5a35-04d0-8bc8819ba825","values":"{\"gateway_data\":{\"switch\":1}}"}'

# 网关属性
mosquitto_pub -h localhost -t "gateway/attributes/16df85ab-a749-5a35-04d0-8bc8819ba825" \
  -m '{"device_id":"16df85ab-a749-5a35-04d0-8bc8819ba825","values":"{\"gateway_data\":{\"online_status\":\"online\"}}"}'

# 网关事件
mosquitto_pub -h localhost -t "gateway/event/16df85ab-a749-5a35-04d0-8bc8819ba825" \
  -m '{"device_id":"16df85ab-a749-5a35-04d0-8bc8819ba825","values":"{\"gateway_data\":{\"method\":\"SystemAlert\",\"params\":{\"alert_type\":\"test\"}}}"}'
```

### 查看实时日志
```bash
# Linux/Mac
tail -f logs/thingspanel.log | grep -E "Flow|gateway|Gateway"

# Windows PowerShell
Get-Content logs\thingspanel.log -Wait | Select-String -Pattern "Flow|gateway|Gateway"
```
